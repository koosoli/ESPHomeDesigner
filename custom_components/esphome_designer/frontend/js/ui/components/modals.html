  <!-- Modals -->
  <!-- Fullscreen Modal -->
  <div id="snippetFullscreenModal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <div style="display: flex; align-items: center; gap: 12px;">
          ESPHome YAML (Fullscreen)
          <button id="toggleFullscreenHighlightBtn" class="btn btn-secondary btn-xs btn-icon"
            title="Toggle Syntax Highlighting" style="width: auto; padding: 0 6px; border-radius: 4px;">
            <span class="mdi mdi-palette-outline" style="font-size: 14px;"></span>
          </button>
        </div>
        <button id="snippetFullscreenClose" class="btn btn-secondary">Close</button>
      </div>
      <div class="modal-body">
        <div class="snippet-container" id="snippetFullscreenContainer" style="height: 100%;">
          <pre id="snippetFullscreenHighlight" class="highlight-layer" aria-hidden="true"></pre>
          <div id="snippetFullscreenContent" style="width: 100%; height: 100%;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="importSnippetModal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <div>Import Layout from YAML</div>
        <button id="importSnippetCancel" class="btn btn-secondary">Cancel</button>
      </div>
      <div class="modal-body">
        <textarea id="importSnippetTextarea" class="prop-input" style="height:400px; font-family:monospace;"
          placeholder="# Paste ESPHome YAML here..."></textarea>
        <div id="importSnippetError" style="color:var(--danger); font-size:11px; margin-top:8px;"></div>
      </div>
      <div class="modal-actions">
        <button id="importSnippetConfirm" class="btn btn-secondary">Import</button>
      </div>
    </div>
  </div>

  <!-- Page Settings Modal -->
  <div id="pageSettingsModal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <div>Page Settings</div>
        <button id="pageSettingsClose" class="btn btn-secondary">Close</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <div class="prop-label">Page Name</div>
          <input id="pageSettingsName" class="prop-input" type="text" />
        </div>
        <div class="field">
          <div class="prop-label">Refresh Mode</div>
          <select id="pageSettingsRefreshMode" class="prop-input">
            <option value="interval">Periodic Interval</option>
            <option value="daily">Daily at specific time</option>
          </select>
        </div>
        <div class="field" id="field-refresh-interval">
          <div class="prop-label">Interval (seconds)</div>
          <input id="pageSettingsRefresh" class="prop-input" type="number" min="0" placeholder="60" />
        </div>
        <div class="field" id="field-refresh-time" style="display:none;">
          <div class="prop-label">Wake-up Time (HH:MM)</div>
          <input id="pageSettingsRefreshTime" class="prop-input" type="time" />
        </div>
        <div class="field">
          <div class="prop-label">Visibility Window</div>
          <div style="display: flex; gap: 8px;">
            <div style="flex: 1;">
              <div style="font-size: 10px; color: var(--muted); margin-bottom: 2px;">Start (Optional)</div>
              <input id="pageSettingsVisibleFrom" class="prop-input" type="time" />
            </div>
            <div style="flex: 1;">
              <div style="font-size: 10px; color: var(--muted); margin-bottom: 2px;">End (Optional)</div>
              <input id="pageSettingsVisibleTo" class="prop-input" type="time" />
            </div>
          </div>
        </div>
        <div class="field">
          <div class="prop-label">Visual Style</div>
          <select id="pageSettingsDarkMode" class="prop-input">
            <option value="inherit">Inherit Global</option>
            <option value="light">Always Light</option>
            <option value="dark">Always Dark</option>
          </select>
        </div>
        <div class="field">
          <div class="prop-label">Layout Mode (LVGL)</div>
          <select id="pageSettingsLayoutMode" class="prop-input">
            <option value="absolute">Absolute Positioning</option>
            <option value="grid">Grid Layout</option>
          </select>
          <div id="field-grid-size" style="display:none; margin-top:8px;">
            <div class="prop-label">Grid Size (RxC)</div>
            <input id="pageSettingsGridSize" class="prop-input" type="text" placeholder="4x4" pattern="[0-9]+x[0-9]+" />
            <div style="font-size:10px; color:var(--muted); margin-top:4px;">Format: rowsÃ—columns, e.g. 2x3, 4x4</div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button id="pageSettingsSave" class="btn btn-secondary">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Device Settings Modal -->
  <div id="deviceSettingsModal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <div>Device Settings</div>
        <button id="deviceSettingsClose" class="btn btn-secondary">Close</button>
      </div>
      <div class="modal-body">
        <div class="settings-grid">
          <!-- PRIMARY SETTINGS (Top 2x2 Grid) -->
          <div class="primary-settings-grid">
            <div class="field">
              <div class="prop-label">Friendly Name</div>
              <input id="deviceName" class="prop-input" type="text" placeholder="My E-Ink Device" />
            </div>

            <div class="field" id="renderingModeField">
              <div class="prop-label">Rendering Mode</div>
              <select id="renderingMode" class="prop-input">
                <option value="direct">Direct (Display Lambda)</option>
                <option value="lvgl">LVGL (Recommended for LCD)</option>
                <option value="oepl">OpenEpaperLink JSON (Drawing Protocol)</option>
                <option value="opendisplay">OpenDisplay JSON (ODP)</option>
              </select>
            </div>

            <div class="field">
              <div class="prop-label">Screen Orientation</div>
              <select id="deviceOrientation" class="prop-input">
                <option value="landscape">Landscape</option>
                <option value="portrait">Portrait</option>
              </select>
            </div>
          </div>

          <!-- SECONDARY SETTINGS (Left Column) -->
          <div class="settings-column">
            <!-- Dynamic Hardware Profile Section (ESPHome Only) -->
            <div class="field" id="deviceModelField"
              style="border-bottom: 1px solid var(--border-subtle); padding-bottom: 12px; margin-bottom: 8px;">
              <div class="prop-label" style="display:flex; justify-content:space-between; align-items:center;">
                <span>Hardware Profile</span>
                <div style="display: flex; gap: 4px;">
                  <button id="reloadHardwareBtn" class="btn btn-secondary btn-xs"
                    style="font-size: 10px; padding: 2px 6px;" title="Reload hardware profiles from server">âŸ³
                    Reload</button>
                  <button id="importHardwareBtn" class="btn btn-secondary btn-xs"
                    style="font-size: 10px; padding: 2px 6px;">Import Recipe</button>
                </div>
              </div>
              <select id="deviceModel" class="prop-input">
                <option value="custom">Custom Profile...</option>
              </select>
              <input type="file" id="hardwareFileInput" accept=".yaml" style="display:none;" />
            </div>

            <!-- OpenEpaperLink Settings -->
            <div id="oeplSettingsSection" style="display:none;">
              <div style="font-size: 11px; font-weight: bold; color: var(--accent); margin-bottom: 8px;">
                OpenEpaperLink Configuration</div>
              <div class="field">
                <div class="prop-label">OEPL Tag Entity ID</div>
                <input id="oeplEntityId" class="prop-input" type="text"
                  placeholder="open_epaper_link.0000000000000000" />
              </div>
              <div class="field">
                <div class="prop-label">Dithering Algorithm</div>
                <select id="oeplDither" class="prop-input">
                  <option value="0">None (Faster)</option>
                  <option value="1">Ordered</option>
                  <option value="2" selected>Burkes (Recommended)</option>
                  <option value="3">Atkinson</option>
                  <option value="4">Floyd-Steinberg</option>
                  <option value="5">Jarvis-Judice-Ninke</option>
                  <option value="6">Stucki</option>
                  <option value="7">Sierra</option>
                </select>
              </div>
            </div>

            <!-- OpenDisplay Settings -->
            <div id="odpSettingsSection" style="display:none;">
              <div style="font-size: 11px; font-weight: bold; color: var(--accent); margin-bottom: 8px;">
                OpenDisplay Configuration (ODP)</div>
              <div class="field">
                <div class="prop-label">ODP Display Entity ID</div>
                <input id="opendisplayEntityId" class="prop-input" type="text"
                  placeholder="opendisplay.0000000000000000" />
              </div>
              <div class="field">
                <div class="prop-label">Dithering Algorithm</div>
                <select id="opendisplayDither" class="prop-input">
                  <option value="0">None (Faster)</option>
                  <option value="1">Ordered</option>
                  <option value="2" selected>Burkes (Recommended)</option>
                  <option value="3">Atkinson</option>
                  <option value="4">Floyd-Steinberg</option>
                  <option value="5">Jarvis-Judice-Ninke</option>
                  <option value="6">Stucki</option>
                  <option value="7">Sierra</option>
                </select>
              </div>
              <div class="field">
                <div class="prop-label">Update Interval (TTL)</div>
                <input id="opendisplayTtl" class="prop-input" type="number" min="0" placeholder="60" />
                <div style="font-size:9px; color:var(--muted); margin-top:4px;">In seconds. 0 = never expires.</div>
              </div>
            </div>

            <!-- Custom Hardware Section -->
            <div id="customHardwareSection"
              style="display:none; border:1px solid var(--accent); border-radius:8px; padding:12px; background: rgba(82, 199, 234, 0.03);">
              <div
                style="font-size:11px; font-weight:bold; color:var(--accent); margin-bottom:12px; display:flex; align-items:center; gap:8px;">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                  <path
                    d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z">
                  </path>
                </svg>
                Custom Hardware Pinout
              </div>

              <div class="hardware-group" style="border:none; margin:0; padding:0;">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                  <div class="field">
                    <div class="prop-label" style="font-size:10px;">Chip Type</div>
                    <select id="customChip" class="prop-input-sm">
                      <option value="esp32-s3">ESP32-S3</option>
                      <option value="esp32">ESP32</option>
                      <option value="esp32-c3">ESP32-C3</option>
                      <option value="esp32-c6">ESP32-C6</option>
                      <option value="esp8266">ESP8266 (Experimental)</option>
                    </select>
                  </div>
                  <div class="field">
                    <div class="prop-label" style="font-size:10px;">Tech</div>
                    <select id="customTech" class="prop-input-sm">
                      <option value="lcd">LCD / OLED</option>
                      <option value="epaper">E-Paper</option>
                    </select>
                  </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                  <div class="field">
                    <div class="prop-label" style="font-size:10px;">Resolution Preset</div>
                    <select id="customResPreset" class="prop-input-sm">
                      <option value="custom">Manual...</option>
                      <!-- LCD / OLED -->
                      <optgroup label="LCD / OLED">
                        <option value="128x64">128x64 (0.96")</option>
                        <option value="128x128">128x128 (1.44")</option>
                        <option value="240x240">240x240 (1.3/1.54")</option>
                        <option value="320x240">320x240 (2.4/2.8")</option>
                        <option value="320x480">320x480 (3.5")</option>
                        <option value="480x320">480x320 (3.5" alt)</option>
                        <option value="480x480">480x480 (Round/Square)</option>
                        <option value="800x480">800x480 (4-7")</option>
                        <option value="1024x600">1024x600 (7-10")</option>
                      </optgroup>
                      <!-- E-Paper -->
                      <optgroup label="E-Paper">
                        <option value="250x122">2.13" (250x122)</option>
                        <option value="296x128">2.9" (296x128)</option>
                        <option value="400x300">4.2" (400x300)</option>
                        <option value="600x448">5.65" (600x448 7-Color)</option>
                        <option value="640x384">5.83" (640x384)</option>
                        <option value="800x480">7.5" (800x480)</option>
                        <option value="880x528">7.5" HD (880x528)</option>
                      </optgroup>
                    </select>
                  </div>
                  <div class="field">
                    <div class="prop-label" style="font-size:10px;">Shape</div>
                    <select id="customShape" class="prop-input-sm">
                      <option value="rect">Rectangle</option>
                      <option value="round">Round</option>
                    </select>
                  </div>
                </div>
                <div class="field">
                  <div class="prop-label" style="font-size:10px;">Manual Resolution</div>
                  <input id="customRes" class="prop-input-sm" type="text" placeholder="800x480" value="800x480" />
                </div>
                <div style="display:flex; gap:16px; margin-top:8px;">
                  <label style="display:flex; align-items:center; gap:6px; font-size:10px; cursor:pointer;">
                    <input id="customPsram" type="checkbox" checked />
                    <span>PSRAM</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:10px; cursor:pointer;">
                    <input id="customAntiburn" type="checkbox" />
                    <span>Anti-burn (LCD)</span>
                  </label>
                </div>
              </div>

              <!-- GPIO Pin Datalists (allows dropdown + free text) -->
              <datalist id="gpio-pins-esp32">
                <option value="">â€” None â€”</option>
                <option value="GPIO0">GPIO0 (boot)</option>
                <option value="GPIO1">GPIO1 (TX)</option>
                <option value="GPIO2">GPIO2</option>
                <option value="GPIO3">GPIO3 (RX)</option>
                <option value="GPIO4">GPIO4</option>
                <option value="GPIO5">GPIO5</option>
                <option value="GPIO12">GPIO12</option>
                <option value="GPIO13">GPIO13</option>
                <option value="GPIO14">GPIO14</option>
                <option value="GPIO15">GPIO15</option>
                <option value="GPIO16">GPIO16</option>
                <option value="GPIO17">GPIO17</option>
                <option value="GPIO18">GPIO18 (VSPI CLK)</option>
                <option value="GPIO19">GPIO19 (VSPI MISO)</option>
                <option value="GPIO21">GPIO21 (I2C SDA)</option>
                <option value="GPIO22">GPIO22 (I2C SCL)</option>
                <option value="GPIO23">GPIO23 (VSPI MOSI)</option>
                <option value="GPIO25">GPIO25</option>
                <option value="GPIO26">GPIO26</option>
                <option value="GPIO27">GPIO27</option>
                <option value="GPIO32">GPIO32</option>
                <option value="GPIO33">GPIO33</option>
                <option value="GPIO34">GPIO34 (input only)</option>
                <option value="GPIO35">GPIO35 (input only)</option>
                <option value="GPIO36">GPIO36 (input only)</option>
                <option value="GPIO39">GPIO39 (input only)</option>
              </datalist>
              <datalist id="gpio-pins-esp32s3">
                <option value="">â€” None â€”</option>
                <option value="GPIO0">GPIO0</option>
                <option value="GPIO1">GPIO1</option>
                <option value="GPIO2">GPIO2</option>
                <option value="GPIO3">GPIO3</option>
                <option value="GPIO4">GPIO4</option>
                <option value="GPIO5">GPIO5</option>
                <option value="GPIO6">GPIO6</option>
                <option value="GPIO7">GPIO7</option>
                <option value="GPIO8">GPIO8</option>
                <option value="GPIO9">GPIO9</option>
                <option value="GPIO10">GPIO10</option>
                <option value="GPIO11">GPIO11</option>
                <option value="GPIO12">GPIO12</option>
                <option value="GPIO13">GPIO13</option>
                <option value="GPIO14">GPIO14</option>
                <option value="GPIO15">GPIO15</option>
                <option value="GPIO16">GPIO16</option>
                <option value="GPIO17">GPIO17</option>
                <option value="GPIO18">GPIO18</option>
                <option value="GPIO19">GPIO19</option>
                <option value="GPIO20">GPIO20</option>
                <option value="GPIO21">GPIO21</option>
                <option value="GPIO38">GPIO38</option>
                <option value="GPIO39">GPIO39</option>
                <option value="GPIO40">GPIO40</option>
                <option value="GPIO41">GPIO41</option>
                <option value="GPIO42">GPIO42</option>
                <option value="GPIO45">GPIO45</option>
                <option value="GPIO46">GPIO46</option>
                <option value="GPIO47">GPIO47</option>
                <option value="GPIO48">GPIO48</option>
              </datalist>
              <datalist id="gpio-pins-esp8266">
                <option value="">â€” None â€”</option>
                <option value="GPIO16">GPIO16 (D0 - Wake)</option>
                <option value="GPIO5">GPIO5 (D1 - SCL)</option>
                <option value="GPIO4">GPIO4 (D2 - SDA)</option>
                <option value="GPIO0">GPIO0 (D3 - Flash)</option>
                <option value="GPIO2">GPIO2 (D4 - LED)</option>
                <option value="GPIO14">GPIO14 (D5 - SCK)</option>
                <option value="GPIO12">GPIO12 (D6 - MISO)</option>
                <option value="GPIO13">GPIO13 (D7 - MOSI)</option>
                <option value="GPIO15">GPIO15 (D8 - CS)</option>
                <option value="GPIO3">GPIO3 (RX)</option>
                <option value="GPIO1">GPIO1 (TX)</option>
                <option value="GPIO10">GPIO10 (SD3 - Flash)</option>
                <option value="GPIO9">GPIO9 (SD2 - Flash)</option>
              </datalist>

              <div class="hardware-group" style="margin-top:12px;">
                <div class="prop-label" style="font-size:10px; margin-bottom:4px;">Display (SPI)</div>
                <select id="customDisplayDriver" class="prop-input-sm" style="margin-bottom:8px;">
                  <option value="st7789v">ST7789 (LCD)</option>
                  <option value="ili9341">ILI9341 (LCD)</option>
                  <option value="ili9342">ILI9342 (LCD)</option>
                  <option value="ili9488">ILI9488 (LCD)</option>
                  <option value="waveshare_epaper">Waveshare E-Paper</option>
                  <option value="epaper_spi">Generic SPI E-Paper</option>
                  <option value="custom">Other (Custom YAML)</option>
                </select>

                <div id="customDisplayModelField" class="field" style="display:none; margin-bottom:8px;">
                  <div class="prop-label" style="font-size:10px;">Display Model</div>
                  <input id="customDisplayModel" class="prop-input-sm" type="text" placeholder="e.g. 7.50inV2"
                    list="waveshare_models" />
                  <div style="font-size:9px; color:var(--muted);">Required for Waveshare E-Paper</div>

                  <datalist id="waveshare_models">
                    <option value="1.54in">1.54"</option>
                    <option value="1.54inv2">1.54" V2</option>
                    <option value="2.13in">2.13"</option>
                    <option value="2.13inv2">2.13" V2</option>
                    <option value="2.13inv3">2.13" V3</option>
                    <option value="2.13in-ttgo">2.13" TTGO</option>
                    <option value="2.66in">2.66"</option>
                    <option value="2.70in">2.70"</option>
                    <option value="2.90in">2.90"</option>
                    <option value="2.90inv2">2.90" V2</option>
                    <option value="2.90in-dke">2.90" DKE</option>
                    <option value="3.52in">3.52"</option>
                    <option value="3.70in">3.70"</option>
                    <option value="4.20in">4.20"</option>
                    <option value="4.20inv2">4.20" V2</option>
                    <option value="5.65in">5.65" (Color)</option>
                    <option value="5.83in">5.83"</option>
                    <option value="5.83inv2">5.83" V2</option>
                    <option value="7.50in">7.50"</option>
                    <option value="7.50inv2">7.50" V2</option>
                    <option value="7.50inv2p">7.50" V2 (Partial Refresh)</option>
                    <option value="7.50hd">7.50" HD</option>
                  </datalist>
                </div>

                <div id="spiPinsGrid" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px;">
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">CS</div>
                    <input id="pin_cs" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                      placeholder="GPIO10" />
                  </div>
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">DC</div>
                    <input id="pin_dc" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                      placeholder="GPIO11" />
                  </div>
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">RST <span style="opacity:0.5">(opt)</span></div>
                    <div style="display:flex; gap:2px;">
                      <input id="pin_rst" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                        placeholder="(optional)" style="flex:1;" />
                      <button type="button" class="clear-pin-btn" data-target="pin_rst" title="Clear"
                        style="padding:0 4px; font-size:10px; background:#eee; border:1px solid #ccc; border-radius:3px; cursor:pointer;">Ã—</button>
                    </div>
                  </div>
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">BUSY <span style="opacity:0.5">(opt)</span></div>
                    <div style="display:flex; gap:2px;">
                      <input id="pin_busy" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                        placeholder="(optional)" style="flex:1;" />
                      <button type="button" class="clear-pin-btn" data-target="pin_busy" title="Clear"
                        style="padding:0 4px; font-size:10px; background:#eee; border:1px solid #ccc; border-radius:3px; cursor:pointer;">Ã—</button>
                    </div>
                  </div>
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">CLK</div>
                    <input id="pin_clk" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                      placeholder="GPIO18" />
                  </div>
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">MOSI</div>
                    <input id="pin_mosi" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                      placeholder="GPIO23" />
                  </div>
                </div>
              </div>

              <!-- Backlight & I2C Pins -->
              <div class="hardware-group" style="margin-top:12px;">
                <div class="prop-label" style="font-size:10px; margin-bottom:4px;">Backlight & I2C</div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px;">
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">Backlight</div>
                    <input id="pin_backlight" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                      placeholder="GPIO45" />
                  </div>
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">I2C SDA</div>
                    <input id="pin_sda" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                      placeholder="GPIO21" />
                  </div>
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">I2C SCL</div>
                    <input id="pin_scl" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                      placeholder="GPIO22" />
                  </div>
                </div>
              </div>

              <!-- Touch Controller -->
              <div class="hardware-group" style="margin-top:12px;">
                <div class="prop-label" style="font-size:10px; margin-bottom:4px;">Touch Controller</div>
                <select id="customTouchTech" class="prop-input-sm" style="margin-bottom:8px;">
                  <option value="none">None</option>
                  <option value="gt911">GT911 (I2C)</option>
                  <option value="cst816">CST816 (I2C)</option>
                  <option value="ft5x06">FT5x06 (I2C)</option>
                  <option value="xpt2046">XPT2046 (SPI)</option>
                </select>
                <div id="touchPinsGrid" style="display:none; grid-template-columns:1fr 1fr; gap:6px;">
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">Touch INT</div>
                    <input id="pin_touch_int" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                      placeholder="GPIO4" />
                  </div>
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">Touch RST</div>
                    <input id="pin_touch_rst" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                      placeholder="GPIO5" />
                  </div>
                </div>
              </div>

              <!-- Power / Battery -->
              <div class="hardware-group" style="margin-top:12px;">
                <div class="prop-label" style="font-size:10px; margin-bottom:4px;">Power / Battery</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px;">
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">Battery ADC <span style="opacity:0.5">(opt)</span>
                    </div>
                    <div style="display:flex; gap:2px;">
                      <input id="pin_battery_adc" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                        placeholder="e.g. GPIO1" style="flex:1;" />
                      <button type="button" class="clear-pin-btn" data-target="pin_battery_adc" title="Clear"
                        style="padding:0 4px; font-size:10px; background:#eee; border:1px solid #ccc; border-radius:3px; cursor:pointer;">Ã—</button>
                    </div>
                  </div>
                  <div class="field">
                    <div class="prop-label" style="font-size:9px;">Battery Enable <span style="opacity:0.5">(opt)</span>
                    </div>
                    <div style="display:flex; gap:2px;">
                      <input id="pin_battery_enable" class="prop-input-sm" type="text" list="gpio-pins-esp32s3"
                        placeholder="e.g. GPIO21" style="flex:1;" />
                      <button type="button" class="clear-pin-btn" data-target="pin_battery_enable" title="Clear"
                        style="padding:0 4px; font-size:10px; background:#eee; border:1px solid #ccc; border-radius:3px; cursor:pointer;">Ã—</button>
                    </div>
                  </div>
                </div>
                <div style="font-size:9px; color:var(--muted); margin-top:4px;">ADC pin reads battery voltage. Enable
                  pin powers battery circuit (optional).</div>
              </div>

              <div class="field" style="margin-top:12px; border-top:1px solid var(--border-subtle); padding-top:8px;">
                <div class="prop-label" style="font-size:10px;">Recipe Name</div>
                <input id="customProfileName" class="prop-input-sm" type="text" placeholder="e.g. My Custom S3" />
              </div>

              <button id="saveCustomProfileBtn" class="btn btn-primary btn-full" type="button" style="margin-top:12px;">
                ðŸš€ Save Profile
              </button>
            </div>

            <!-- Protocol Hardware Section (OEPL / ODP) -->
            <div id="protocolHardwareSection"
              style="display:none; border:1px solid var(--accent); border-radius:8px; padding:12px; background: rgba(82, 199, 234, 0.03);">
              <div
                style="font-size:11px; font-weight:bold; color:var(--accent); margin-bottom:12px; display:flex; align-items:center; gap:8px;">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                  <line x1="8" y1="21" x2="16" y2="21"></line>
                  <line x1="12" y1="17" x2="12" y2="21"></line>
                </svg>
                Protocol Hardware Specs
              </div>

              <div class="field">
                <div class="prop-label">Resolution Preset</div>
                <select id="protocolResPreset" class="prop-input">
                  <option value="custom">Manual...</option>
                  <option value="296x128">2.9" (296x128)</option>
                  <option value="400x300">4.2" (400x300)</option>
                  <option value="800x480">7.5" (800x480)</option>
                  <option value="640x384">5.83" (640x384)</option>
                  <option value="250x122">2.13" (250x122)</option>
                </select>
              </div>

              <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <div class="field">
                  <div class="prop-label">Width</div>
                  <input id="protocolWidth" class="prop-input" type="number" value="400" />
                </div>
                <div class="field">
                  <div class="prop-label">Height</div>
                  <input id="protocolHeight" class="prop-input" type="number" value="300" />
                </div>
              </div>

              <div class="field">
                <div class="prop-label">Color Mode</div>
                <select id="protocolColorMode" class="prop-input">
                  <option value="bw">Monochrome (B/W)</option>
                  <option value="grayscale">Grayscale</option>
                  <option value="color_3">3-Color (BWR / BWY)</option>
                  <option value="full_color">Full Color</option>
                </select>
              </div>
            </div>

            <!-- Global Preferences -->
            <div class="field" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-subtle);">
              <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                <input id="deviceDarkMode" type="checkbox" />
                <span style="font-size:var(--fs-xs); font-weight:600;">Dark Mode</span>
              </label>
            </div>

            <div class="field" id="deviceInvertedColorsField">
              <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                <input id="deviceInvertedColors" type="checkbox" />
                <span style="font-size:var(--fs-xs); font-weight:600;">Inverted Colors (E-Paper)</span>
              </label>
            </div>
          </div>
        </div>

        <div id="powerStrategySection"
          style="border-top:1px solid var(--border-subtle); margin-top:16px; padding-top:16px;">
          <div class="prop-label">Power & Refresh Strategy</div>

          <div id="global-refresh-row"
            style="margin-top: 12px; margin-bottom: 16px; background: rgba(82, 199, 234, 0.05); padding: 10px; border-radius: 6px; border-left: 3px solid var(--accent);">
            <div class="prop-label" style="font-size: 11px; margin-bottom: 4px;">Global Refresh Interval</div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <input type="number" id="setting-refresh-interval" class="prop-input" placeholder="600"
                style="width: 80px;" min="5">
              <span style="font-size: 11px; opacity: 0.7;">seconds</span>
            </div>
            <div style="font-size: 10px; opacity: 0.6; margin-top: 4px;">Default time between updates. Can be overridden
              on individual pages.</div>
          </div>

          <!-- E-Paper Specific Strategies -->
          <div id="strategy-epaper-group" style="display:flex; flex-direction:column; gap:12px; margin-top:8px;">
            <div
              style="font-size:10px; font-weight:bold; text-transform:uppercase; color:var(--muted); margin-bottom:4px;">
              E-Paper Options</div>

            <!-- Standard -->
            <div>
              <label
                style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:var(--fs-sm); font-weight: 500;">
                <input type="radio" id="mode-standard" name="powerStrategy" value="standard"
                  onchange="togglePowerSettings()">
                Full Power (Always On)
              </label>
              <div style="font-size:10px; opacity:0.6; margin-left:24px;">Device stays connected to Wi-Fi. Fast
                response, but high battery drain.</div>
            </div>

            <!-- Night Mode -->
            <div>
              <label
                style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:var(--fs-sm); font-weight: 500;">
                <input type="radio" id="setting-sleep-enabled" name="powerStrategy" value="night"
                  onchange="togglePowerSettings()">
                Eco (Scheduled Night Sleep)
              </label>
              <div style="font-size:10px; opacity:0.6; margin-left:24px; margin-bottom:4px;">Stops refreshing during
                these hours to save energy.</div>
            </div>

            <!-- Daily Refresh -->
            <div>
              <label
                style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:var(--fs-sm); font-weight: 500;">
                <input type="radio" id="setting-daily-refresh-enabled" name="powerStrategy" value="daily"
                  onchange="togglePowerSettings()">
                Daily Scheduled Refresh
              </label>
              <div style="font-size:10px; opacity:0.6; margin-left:24px; margin-bottom:4px;">Wakes up once per day at a
                specific time.</div>
            </div>

            <!-- Manual Only -->
            <div>
              <label
                style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:var(--fs-sm); font-weight: 500;">
                <input type="radio" id="setting-manual-refresh" name="powerStrategy" value="manual"
                  onchange="togglePowerSettings()">
                Manual Refresh Only
              </label>
              <div style="font-size:10px; opacity:0.6; margin-left:24px;">Never updates automatically. Only refreshes
                when a button is pressed.</div>
            </div>

            <!-- Deep Sleep -->
            <div>
              <label
                style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:var(--fs-sm); font-weight: 500;">
                <input type="radio" id="setting-deep-sleep-enabled" name="powerStrategy" value="deepsleep"
                  onchange="togglePowerSettings()">
                Ultra Eco (Deep Sleep)
              </label>
              <div style="font-size:10px; opacity:0.6; margin-left:24px; margin-bottom:4px;">Shuts down completely
                between updates. Best for battery life.</div>
            </div>
          </div>

          <div id="strategy-lcd-group" style="display:none; flex-direction:column; gap:12px; margin-top:8px;">
            <div
              style="font-size:10px; font-weight:bold; text-transform:uppercase; color:var(--muted); margin-bottom:4px;">
              LCD / OLED Options</div>

            <div>
              <label
                style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:var(--fs-sm); font-weight: 500;">
                <input type="radio" name="lcdEcoStrategy" value="always_on" onchange="togglePowerSettings()">
                Always On (Full Brightness)
              </label>
            </div>

            <div>
              <label
                style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:var(--fs-sm); font-weight: 500;">
                <input type="radio" name="lcdEcoStrategy" value="backlight_off" onchange="togglePowerSettings()">
                Eco (Backlight Off Schedule)
              </label>
              <div style="font-size:10px; opacity:0.6; margin-left:24px;">Turns off backlight during sleep hours
                (recommended for LCD).</div>
            </div>

            <div id="lcd-strategy-dim-row">
              <label
                style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:var(--fs-sm); font-weight: 500;">
                <input type="radio" name="lcdEcoStrategy" value="dim_after_timeout" onchange="togglePowerSettings()">
                Eco (Dim after timeout)
              </label>
              <div style="font-size:10px; opacity:0.6; margin-left:24px;">Turns off backlight and pauses LVGL after
                period of inactivity. Resume on touch.</div>
            </div>

            <div>
              <label
                style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:var(--fs-sm); font-weight: 500;">
                <input type="radio" name="lcdEcoStrategy" value="halt_updates" onchange="togglePowerSettings()">
                Eco (Halt Loop)
              </label>
              <div style="font-size:10px; opacity:0.6; margin-left:24px;">Stops update cycle but leaves screen powered.
              </div>
            </div>

            <div>
              <label
                style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:var(--fs-sm); font-weight: 500;">
                <input type="radio" name="lcdEcoStrategy" value="deep_sleep" onchange="togglePowerSettings()">
                Ultra Eco (Deep Sleep)
              </label>
              <div style="font-size:10px; opacity:0.6; margin-left:24px;">Power down between updates.</div>
            </div>
          </div>

          <!-- Dim Timeout (Used by LCD Dim after timeout) -->
          <div id="dim-timeout-row"
            style="display:none; align-items:center; gap:8px; margin-left:24px; margin-top:8px; background: rgba(0,0,0,0.03); padding: 4px 8px; border-radius: 4px;">
            <span style="font-size: 11px; opacity: 0.7;">Dim after</span>
            <input type="number" id="setting-dim-timeout" class="prop-input" placeholder="10" style="width:80px;"
              min="1" value="10">
            <span style="font-size: 11px; opacity: 0.7;">seconds</span>
          </div>

          <!-- Common Sleep Times (Used by both) -->
          <div id="sleep-times-row"
            style="display:none; flex-direction:column; gap:8px; margin-left:24px; margin-top:8px; background: rgba(0,0,0,0.03); padding: 8px; border-radius: 4px;">
            <div style="display:flex; align-items:center; gap:8px;">
              <span style="font-size: 11px; opacity: 0.7;">Sleep from</span>
              <select id="setting-sleep-start" class="prop-input" style="width:70px;">
                <option value="0">00:00</option>
                <option value="1">01:00</option>
                <option value="2">02:00</option>
                <option value="3">03:00</option>
                <option value="4">04:00</option>
                <option value="5">05:00</option>
                <option value="6">06:00</option>
                <option value="7">07:00</option>
                <option value="8">08:00</option>
                <option value="9">09:00</option>
                <option value="10">10:00</option>
                <option value="11">11:00</option>
                <option value="12">12:00</option>
                <option value="13">13:00</option>
                <option value="14">14:00</option>
                <option value="15">15:00</option>
                <option value="16">16:00</option>
                <option value="17">17:00</option>
                <option value="18">18:00</option>
                <option value="19">19:00</option>
                <option value="20">20:00</option>
                <option value="21">21:00</option>
                <option value="22">22:00</option>
                <option value="23">23:00</option>
              </select>
              <span style="font-size: 11px; opacity: 0.7;">to</span>
              <select id="setting-sleep-end" class="prop-input" style="width:70px;">
                <option value="0">00:00</option>
                <option value="1">01:00</option>
                <option value="2">02:00</option>
                <option value="3">03:00</option>
                <option value="4">04:00</option>
                <option value="5">05:00</option>
                <option value="6">06:00</option>
                <option value="7">07:00</option>
                <option value="8">08:00</option>
                <option value="9">09:00</option>
                <option value="10">10:00</option>
                <option value="11">11:00</option>
                <option value="12">12:00</option>
                <option value="13">13:00</option>
                <option value="14">14:00</option>
                <option value="15">15:00</option>
                <option value="16">16:00</option>
                <option value="17">17:00</option>
                <option value="18">18:00</option>
                <option value="19">19:00</option>
                <option value="20">20:00</option>
                <option value="21">21:00</option>
                <option value="22">22:00</option>
                <option value="23">23:00</option>
              </select>
            </div>
          </div>

          <div id="daily-refresh-row"
            style="display:none; align-items:center; gap:8px; margin-left:24px; margin-top:8px; background: rgba(0,0,0,0.03); padding: 4px 8px; border-radius: 4px;">
            <span style="font-size: 11px; opacity: 0.7;">Refresh at</span>
            <input type="time" id="setting-daily-refresh-time" class="prop-input" value="08:00" style="width:100px;">
          </div>

          <div id="deep-sleep-interval-row"
            style="display:none; align-items:center; gap:8px; margin-left:24px; margin-top:8px; background: rgba(0,0,0,0.03); padding: 4px 8px; border-radius: 4px;">
            <span style="font-size: 11px; opacity: 0.7;">Update every</span>
            <input type="number" id="setting-deep-sleep-interval" class="prop-input" placeholder="Seconds"
              style="width:80px;">
            <span style="font-size: 11px; opacity: 0.7;">sec</span>
          </div>

          <!-- Silent Hours -->
          <div style="border-top:1px solid var(--border-subtle); margin-top:8px; padding-top:12px;">
            <div
              style="display:flex; align-items:center; gap:8px; font-size:var(--fs-sm); font-weight: 500; color: var(--accent);">
              <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <path
                  d="M17.22 17.22L2 2M12 2v2M4.93 4.93l1.41 1.41M2 12h2M6.34 17.66l-1.41 1.41M12 22v-2m7.07-2.93l-1.41-1.41M22 12h-2m-3.34-5.66l1.41-1.41M12 7a5 5 0 015 5 4.94 4.94 0 01-.46 2.06M12 17a5 5 0 01-5-5 4.94 4.94 0 01.46-2.06">
                </path>
              </svg>
              Silent Hours (No Refresh Window)
            </div>
            <div style="font-size:10px; opacity:0.6; margin-left:24px; margin-bottom:8px;">Prevent all display
              updates
              during this time window. Used to avoid night-time ghosts/noise.</div>
            <div
              style="display:flex; align-items:center; gap:8px; margin-left:24px; background: rgba(0,0,0,0.03); padding: 4px 8px; border-radius: 4px;">
              <span style="font-size: 11px; opacity: 0.7;">Disable updates from</span>
              <select id="setting-no-refresh-start" class="prop-input" style="width:70px;">
                <option value="">None</option>
                <option value="0">00:00</option>
                <option value="1">01:00</option>
                <option value="2">02:00</option>
                <option value="3">03:00</option>
                <option value="4">04:00</option>
                <option value="5">05:00</option>
                <option value="6">06:00</option>
                <option value="7">07:00</option>
                <option value="8">08:00</option>
                <option value="9">09:00</option>
                <option value="10">10:00</option>
                <option value="11">11:00</option>
                <option value="12">12:00</option>
                <option value="13">13:00</option>
                <option value="14">14:00</option>
                <option value="15">15:00</option>
                <option value="16">16:00</option>
                <option value="17">17:00</option>
                <option value="18">18:00</option>
                <option value="19">19:00</option>
                <option value="20">20:00</option>
                <option value="21">21:00</option>
                <option value="22">22:00</option>
                <option value="23">23:00</option>
              </select>
              <span style="font-size: 11px; opacity: 0.7;">to</span>
              <select id="setting-no-refresh-end" class="prop-input" style="width:70px;">
                <option value="">None</option>
                <option value="0">00:00</option>
                <option value="1">01:00</option>
                <option value="2">02:00</option>
                <option value="3">03:00</option>
                <option value="4">04:00</option>
                <option value="5">05:00</option>
                <option value="6">06:00</option>
                <option value="7">07:00</option>
                <option value="8">08:00</option>
                <option value="9">09:00</option>
                <option value="10">10:00</option>
                <option value="11">11:00</option>
                <option value="12">12:00</option>
                <option value="13">13:00</option>
                <option value="14">14:00</option>
                <option value="15">15:00</option>
                <option value="16">16:00</option>
                <option value="17">17:00</option>
                <option value="18">18:00</option>
                <option value="19">19:00</option>
                <option value="20">20:00</option>
                <option value="21">21:00</option>
                <option value="22">22:00</option>
                <option value="23">23:00</option>
              </select>
            </div>
          </div>

          <!-- Page Auto-Cycling -->
          <div style="border-top:1px solid var(--border-subtle); margin-top:8px; padding-top:12px;">
            <div
              style="display:flex; align-items:center; gap:8px; font-size:var(--fs-sm); font-weight: 600; color: var(--accent);">
              <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
              </svg>
              Page Auto-Cycling
            </div>
            <div style="font-size:10px; opacity:0.6; margin-left:24px; margin-bottom:8px;">Automatically cycle
              through
              pages on a timer.</div>
            <div style="margin-left: 24px; display: flex; flex-direction: column; gap: 8px;">
              <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                <input id="setting-auto-cycle" type="checkbox" />
                <span style="font-size:var(--fs-xs); font-weight:500;">Enable Automatic Page Cycling</span>
              </label>
              <div id="field-auto-cycle-interval"
                style="display:none; align-items:center; gap:8px; background: rgba(0,0,0,0.03); padding: 4px 8px; border-radius: 4px;">
                <span style="font-size: 11px; opacity: 0.7;">Cycle every</span>
                <input type="number" id="setting-auto-cycle-interval" class="prop-input" min="5" placeholder="30"
                  style="width:80px;">
                <span style="font-size: 11px; opacity: 0.7;">seconds</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button id="deviceSettingsSave" class="btn btn-secondary">Apply Settings</button>
      </div>
    </div>
  </div>

  <!-- Save Profile Modal -->
  <div id="saveProfileModal" class="modal-backdrop hidden" style="z-index: 2000;">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <div>Save Hardware Profile</div>
        <button id="saveProfileClose" class="btn btn-secondary">Cancel</button>
      </div>
      <div class="modal-body">
        <div style="font-size: 11px; opacity: 0.7; margin-bottom: 12px;">
          Give your custom hardware configuration a unique name. It will be saved as a reusable recipe.
        </div>
        <div class="field">
          <div class="prop-label">Profile Name</div>
          <input id="saveProfileName" class="prop-input" type="text" placeholder="e.g. Living Room Display" />
        </div>
      </div>
      <div class="modal-actions">
        <button id="saveProfileConfirm" class="btn btn-secondary"
          style="background: var(--accent); color: white; border: none;">Save Profile</button>
      </div>
    </div>
  </div>

  <!-- Editor Settings Modal -->
  <div id="editorSettingsModal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <div>Editor Preferences</div>
        <button id="editorSettingsClose" class="btn btn-secondary">Close</button>
      </div>
      <div class="modal-body">
        <!-- CATEGORY: VIEW & THEME -->
        <div class="settings-category collapsible expanded" data-category="view">
          <div class="settings-category-header">
            <div style="display:flex; align-items:center; gap:8px;">
              <span class="mdi mdi-eye-outline"></span>
              <span>View & Theme</span>
            </div>
            <span class="mdi mdi-chevron-down category-chevron"></span>
          </div>
          <div class="settings-category-content">
            <div class="field">
              <label style="display:flex; align-items:center; gap:8px; cursor: pointer;">
                <input type="checkbox" id="editorShowGrid" checked> <span>Show Grid</span>
              </label>
              <label style="display:flex; align-items:center; gap:8px; cursor: pointer;">
                <input type="checkbox" id="editorSnapToGrid" checked> <span>Enable Snapping</span>
              </label>
              <div style="margin-top:12px;">
                <div class="prop-label">Grid Opacity</div>
                <input type="range" id="editorGridOpacity" min="0" max="100" step="1" value="8" style="width:100%;">
              </div>
            </div>
            <div class="field">
              <div class="prop-label">Interface Theme</div>
              <label style="display:flex; align-items:center; gap:8px; cursor: pointer;">
                <input type="checkbox" id="editorLightMode"> <span>Use Light Mode interface</span>
              </label>
            </div>
          </div>
        </div>

        <!-- CATEGORY: FONT SETTINGS -->
        <div class="settings-category collapsible" data-category="fonts">
          <div class="settings-category-header">
            <div style="display:flex; align-items:center; gap:8px;">
              <span class="mdi mdi-format-font"></span>
              <span>Font Settings</span>
            </div>
            <span class="mdi mdi-chevron-down category-chevron"></span>
          </div>
          <div class="settings-category-content">
            <div class="field">
              <div class="prop-label">Global Glyphsets</div>
              <div style="font-size:10px; opacity:0.6; margin-bottom:8px;">Select glyphsets to include language specific
                characters (like Ã¥, Ã¶, Ã¤) in the generated YAML for all fonts.</div>
              <div id="editorGlyphsets"
                style="display:grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                <label style="display:flex; align-items:center; gap:8px; font-size: 11px; cursor: pointer;">
                  <input type="checkbox" class="glyphset-checkbox" value="GF_Latin_Kernel"> <span>Latin Kernel <small
                      style="opacity:0.6">(Basic A-Z, 0-9)</small></span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size: 11px; cursor: pointer;">
                  <input type="checkbox" class="glyphset-checkbox" value="GF_Latin_Core"> <span>Latin Core <small
                      style="opacity:0.6">(Ã¥, Ã¶, Ã¤, Ã©, ÃŸ...)</small></span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size: 11px; cursor: pointer;">
                  <input type="checkbox" class="glyphset-checkbox" value="GF_Arabic_Core"> <span>Arabic Core <small
                      style="opacity:0.6">(Ø§, Ø¨, Øª...)</small></span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size: 11px; cursor: pointer;">
                  <input type="checkbox" class="glyphset-checkbox" value="GF_Cyrillic_Core"> <span>Cyrillic <small
                      style="opacity:0.6">(Ð, Ð‘, Ð’...)</small></span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size: 11px; cursor: pointer;">
                  <input type="checkbox" class="glyphset-checkbox" value="GF_Greek_Core"> <span>Greek <small
                      style="opacity:0.6">(Î±, Î², Î³...)</small></span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size: 11px; cursor: pointer;">
                  <input type="checkbox" class="glyphset-checkbox" value="GF_Latin_African"> <span>Latin African</span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size: 11px; cursor: pointer;">
                  <input type="checkbox" class="glyphset-checkbox" value="GF_Latin_PriAfrican"> <span>Latin
                    PriAfrican</span>
                </label>
                <label style="display:flex; align-items:center; gap:8px; font-size: 11px; cursor: pointer;">
                  <input type="checkbox" class="glyphset-checkbox" value="GF_Latin_Vietnamese"> <span>Vietnamese <small
                      style="opacity:0.6">(Ã , Ã¡, áº£...)</small></span>
                </label>
              </div>
              <div style="margin-top:8px; padding-top:8px; border-top:1px dashed rgba(255,255,255,0.08);">
                <label style="display:flex; align-items:center; gap:8px; font-size: 11px; cursor: pointer;">
                  <input type="checkbox" id="editorExtendedLatinGlyphs">
                  <span>Extended Latin Glyphs <small style="opacity:0.6">(Manual fallback: â‚¬, Âµ, Î©, â„¢ + full
                      Latin-1)</small></span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- CATEGORY: CONNECTIVITY -->
        <div class="settings-category collapsible" data-category="ha">
          <div class="settings-category-header">
            <div style="display:flex; align-items:center; gap:8px;">
              <span class="mdi mdi-home-assistant"></span>
              <span>Home Assistant</span>
            </div>
            <span class="mdi mdi-chevron-down category-chevron"></span>
          </div>
          <div class="settings-category-content">
            <div class="field">
              <div class="prop-label">Resources</div>
              <button id="editorRefreshEntities" class="btn btn-secondary btn-xs">Refresh Entity List</button>
              <span id="editorEntityCount" style="font-size:var(--fs-xs); opacity:0.6; margin-left:8px;"></span>
            </div>
            <div class="field">
              <div class="prop-label">Connection Settings</div>
              <div style="font-size:10px; opacity:0.6; margin-bottom:8px;">Configure this if you are using the
                GitHub-hosted version or an external URL.</div>
              <div style="display:flex; flex-direction:column; gap:8px;">
                <div id="haCorsTip"
                  style="background: rgba(82, 199, 234, 0.1); border-left: 3px solid var(--accent); padding: 10px; border-radius: 4px; font-size: 10px; line-height: 1.4;">
                  <strong>ðŸ’¡ Connection Tip:</strong><br>
                  If requests are blocked, you may need to add <code
                    id="haOriginPlaceholder">http://localhost:8000</code> to <code>cors_allowed_origins</code> and
                  <strong>restart HA</strong>.
                </div>
                <div>
                  <div class="prop-label" style="font-size: 10px;">Base URL</div>
                  <input type="text" id="haManualUrl" class="prop-input"
                    placeholder="https://your-ha.duckdns.org:8123" />
                </div>
                <div>
                  <div class="prop-label" style="font-size: 10px;">Long-Lived Access Token</div>
                  <input type="password" id="haLlatToken" class="prop-input" placeholder="Paste your token here..." />
                </div>
                <!-- Warning shown only when deployed within HA -->
                <div id="haDeployedWarning" class="hidden"
                  style="background: rgba(46, 204, 113, 0.1); border-left: 3px solid #2ecc71; padding: 10px; border-radius: 4px; font-size: 10px; line-height: 1.4; color: #2ecc71;">
                  <strong>âœ… Deployed in Home Assistant:</strong><br>
                  Connection is handled automatically. These settings are locked to prevent configuration errors.
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                  <button id="editorTestHaBtn" class="btn btn-secondary btn-xs" style="flex:1;">Test Connection</button>
                  <div id="haTestResult" style="font-size:10px; line-height: 1.2;"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- CATEGORY: AI ASSISTANT -->
        <div class="settings-category collapsible" data-category="ai">
          <div class="settings-category-header">
            <div style="display:flex; align-items:center; gap:8px;">
              <span class="mdi mdi-robot-outline"></span>
              <span>AI Integration (LLM)</span>
            </div>
            <span class="mdi mdi-chevron-down category-chevron"></span>
          </div>
          <div class="settings-category-content">
            <div style="font-size:10px; opacity:0.6; margin-bottom:8px;">Configure Gemini, OpenAI or OpenRouter to use
              natural language prompts.</div>
            <div class="field" style="display:flex; flex-direction:column; gap:8px;">
              <div>
                <div class="prop-label" style="font-size: 10px;">Provider</div>
                <select id="aiProvider" class="prop-input">
                  <option value="gemini">Google Gemini</option>
                  <option value="openai">OpenAI</option>
                  <option value="openrouter">OpenRouter</option>
                </select>
              </div>
              <div id="aiKeyGeminiRow">
                <div class="prop-label" style="font-size: 10px;">Gemini API Key</div>
                <input type="password" id="aiApiKeyGemini" class="prop-input" placeholder="Paste Gemini key..." />
              </div>
              <div id="aiKeyOpenaiRow" style="display:none;">
                <div class="prop-label" style="font-size: 10px;">OpenAI API Key</div>
                <input type="password" id="aiApiKeyOpenai" class="prop-input" placeholder="Paste OpenAI key..." />
              </div>
              <div id="aiKeyOpenrouterRow" style="display:none;">
                <div class="prop-label" style="font-size: 10px;">OpenRouter API Key</div>
                <input type="password" id="aiApiKeyOpenrouter" class="prop-input"
                  placeholder="Paste OpenRouter key..." />
              </div>
              <div>
                <div class="prop-label" style="font-size: 10px;">Model Filter (e.g. "free", "flash", "gpt-4")</div>
                <div style="display:flex; gap:4px; align-items: center;">
                  <input type="text" id="aiModelFilter" class="prop-input" placeholder="Filter models..."
                    style="flex:1;" />
                  <button id="aiRefreshModelsBtn" class="btn btn-secondary btn-xs">Test & Load Models</button>
                  <div id="aiTestResult" style="font-size:10px; line-height: 1.2;"></div>
                </div>
              </div>
              <div>
                <div class="prop-label" style="font-size: 10px;">Selected Model</div>
                <select id="aiModelSelect" class="prop-input"></select>
              </div>
            </div>
          </div>
        </div>

        <!-- CATEGORY: SHORTCUTS -->
        <div class="settings-category collapsible" data-category="shortcuts">
          <div class="settings-category-header">
            <div style="display:flex; align-items:center; gap:8px;">
              <span class="mdi mdi-keyboard-outline"></span>
              <span>Keyboard Shortcuts</span>
            </div>
            <span class="mdi mdi-chevron-down category-chevron"></span>
          </div>
          <div class="settings-category-content">
            <div class="shortcuts-grid">
              <div class="shortcut-item"><span class="shortcut-label">Undo</span><span
                  class="shortcut-key"><kbd>Ctrl+Z</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Redo</span><span
                  class="shortcut-key"><kbd>Ctrl+Y</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Copy</span><span
                  class="shortcut-key"><kbd>Ctrl+C</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Paste</span><span
                  class="shortcut-key"><kbd>Ctrl+V</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Delete</span><span
                  class="shortcut-key"><kbd>DEL</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Lock/Unlock</span><span
                  class="shortcut-key"><kbd>Ctrl+L</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Search</span><span
                  class="shortcut-key"><kbd>Shift+Space</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Debug Mode</span><span
                  class="shortcut-key"><kbd>D</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Design Grid</span><span
                  class="shortcut-key"><kbd>G</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Rulers</span><span
                  class="shortcut-key"><kbd>R</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Zoom Reset</span><span
                  class="shortcut-key"><kbd>Ctrl+R</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Snap Off</span><span
                  class="shortcut-key"><kbd>ALT</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Distances</span><span
                  class="shortcut-key"><kbd>CTRL Drag</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Group</span><span
                  class="shortcut-key"><kbd>Ctrl+G</kbd></span></div>
              <div class="shortcut-item"><span class="shortcut-label">Ungroup</span><span
                  class="shortcut-key"><kbd>Ctrl+Shift+G</kbd></span></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button id="editorSettingsDone" class="btn btn-secondary">Done</button>
      </div>
    </div>
  </div>

  <!-- AI Prompt Modal -->
  <div id="aiPromptModal" class="modal-backdrop hidden">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <div>AI Design Assistant</div>
        <button id="aiPromptClose" class="btn btn-secondary">Close</button>
      </div>
      <div class="modal-body">
        <div id="aiConfigWarning"
          style="background: rgba(82, 199, 234, 0.1); border-left: 3px solid var(--accent); padding: 10px; border-radius: 4px; font-size: 11px; margin-bottom: 12px; line-height: 1.4;">
          <strong>ðŸ’¡ Configuration Required:</strong><br>
          An API provider and key must be configured in <strong>Editor Settings</strong> before using the AI
          Assistant.
          <button
            onclick="window.openEditorSettingsModal('ai'); document.getElementById('aiPromptModal').classList.add('hidden');"
            class="btn btn-secondary btn-xs" style="margin-top:8px; display:block;">âš™ Open Editor
            Settings</button>
        </div>
        <div style="font-size: 11px; color: var(--muted); margin-bottom: 12px;">
          Describe what you want to change. Example: "Move the selected widget 50px right" or "Make a nice weather
          layout with 4 days forecast".
        </div>
        <textarea id="aiPromptInput" class="prop-input"
          style="height: 120px; font-size: 14px; line-height: 1.5; padding: 12px;"
          placeholder="I want to..."></textarea>

        <div id="aiPromptStatus" style="margin-top: 12px; font-size: 11px; min-height: 1.2em;"></div>

        <div id="aiPreviewDiff"
          style="display:none; margin-top:16px; border: 1px solid var(--border-subtle); border-radius: 8px; overflow: hidden;">
          <div
            style="background: rgba(255,255,255,0.03); padding: 8px 12px; font-size: 10px; font-weight: 600; border-bottom: 1px solid var(--border-subtle);">
            PREVIEW CHANGES</div>
          <div id="aiDiffContent"
            style="padding: 12px; font-family: monospace; font-size: 11px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; background: var(--bg-input);">
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button id="aiPromptSubmit" class="btn btn-primary"
          style="background: var(--accent); color: white; border: none;">Generate</button>
        <button id="aiPromptApply" class="btn btn-success" style="display:none;">Apply</button>
      </div>
    </div>
  </div>

